<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      EcoLista
    </ion-title>
    <ion-buttons slot="end">
      <ion-button routerLink="/perfil" fill="clear">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding home-content">
  <ion-refresher slot="fixed" (ionRefresh)="refreshTips($event)">
    <ion-refresher-content pullingText="Desliza para actualizar consejos"></ion-refresher-content>
  </ion-refresher>

  <ion-progress-bar
    *ngIf="(productLoading$ | async) || (tipsLoading$ | async)"
    type="indeterminate"
    color="success"
  ></ion-progress-bar>

  <ion-chip color="warning" *ngIf="offline$ | async" class="ion-margin-bottom">
    <ion-icon name="cloud-offline" color="warning"></ion-icon>
    <ion-label>Conectividad limitada: usando datos guardados.</ion-label>
  </ion-chip>

  <ion-note color="warning" *ngIf="syncError$ | async as syncError" class="ion-margin-bottom">
    {{ syncError }}
  </ion-note>

  <ion-card #welcomeCard>
    <ion-card-header>
      <ion-card-title>Bienvenida/o a tu compra consciente</ion-card-title>
      <ion-card-subtitle>
        Gestiona tus alimentos frescos, evita desperdicios y ahorra tiempo cada semana.
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-button expand="block" color="success" (click)="goToList()">
        <ion-icon slot="start" name="leaf"></ion-icon>
        Ver la EcoLista
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="summary$ | async as summary; else summarySkeleton">
    <ion-card-header>
      <ion-card-title>Resumen rápido</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="summary-grid">
        <div>
          <h3>{{ summary.total }}</h3>
          <p>Productos registrados</p>
        </div>
        <div>
          <h3>{{ summary.nearExpiry }}</h3>
          <p>Por vencer en 3 días</p>
        </div>
        <div>
          <h3>{{ summary.purchased }}</h3>
          <p>Comprados recientemente</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <ng-template #summarySkeleton>
    <ion-card>
      <ion-card-header>
        <ion-card-title>Resumen rápido</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="summary-grid">
          <ion-skeleton-text animated style="width: 60px; height: 24px"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 60px; height: 24px"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 60px; height: 24px"></ion-skeleton-text>
        </div>
      </ion-card-content>
    </ion-card>
  </ng-template>

  <ion-card class="alerts-card" *ngIf="nearExpiry$ | async as alerts; else loadingAlerts">
    <ion-card-header>
      <ion-card-title>Recomendaciones sostenibles</ion-card-title>
      <ion-card-subtitle>Prioriza estos alimentos para evitar desperdicios.</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-list lines="none" *ngIf="alerts.length; else emptyAlerts">
        <ion-item *ngFor="let product of alerts">
          <ion-icon slot="start" name="alarm-outline" color="warning"></ion-icon>
          <ion-label>
            <h3>{{ product.name }}</h3>
            <p>Vence en {{ product.expiry }}</p>
          </ion-label>
          <ion-chip color="warning" outline>
            <ion-label>{{ product.priority }}</ion-label>
          </ion-chip>
        </ion-item>
      </ion-list>
      <ng-template #emptyAlerts>
        <p class="empty-state">Sin alertas por ahora. ¡Disfruta tus alimentos frescos!</p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <ng-template #loadingAlerts>
    <ion-card class="alerts-card">
      <ion-card-header>
        <ion-card-title>Recomendaciones sostenibles</ion-card-title>
        <ion-card-subtitle>Sincronizando tu inventario...</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-skeleton-text animated style="width: 100%; height: 56px"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 56px"></ion-skeleton-text>
      </ion-card-content>
    </ion-card>
  </ng-template>

  <ion-card *ngIf="tips$ | async as tips">
    <ion-card-header>
      <ion-card-title>Consejos EcoLista</ion-card-title>
      <ion-card-subtitle>{{ tips.message }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-chip color="tertiary" *ngIf="tips.fromCache" class="cache-chip" outline>
        <ion-icon name="cloud-offline-outline"></ion-icon>
        <ion-label>Cache local</ion-label>
      </ion-chip>
      <ng-container *ngIf="tipsLoading$ | async as tipsLoading">
        <div class="tips-loading" *ngIf="tipsLoading">
          <ion-spinner name="crescent" color="success"></ion-spinner>
          <p>Obteniendo consejos sostenibles...</p>
        </div>
        <ion-list *ngIf="!tipsLoading && tips.tips.length; else emptyTips" lines="none">
          <ion-item *ngFor="let tip of tips.tips">
            <ion-icon name="leaf-outline" slot="start"></ion-icon>
            <ion-label>
              <h3>{{ tip.author }}</h3>
              <p>{{ tip.quote }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ng-container>
      <ng-template #emptyTips>
        <p class="empty-state">Aún no hay consejos guardados. Refresca para intentarlo de nuevo.</p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <ion-card class="actions-card">
    <ion-card-header>
      <ion-card-title>Acciones rápidas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="actions">
        <ion-button routerLink="/lista" color="primary" fill="outline">
          <ion-icon slot="start" name="cart-outline"></ion-icon>
          Gestionar la EcoLista
        </ion-button>
        <ion-button routerLink="/perfil" color="tertiary" fill="outline">
          <ion-icon slot="start" name="trophy-outline"></ion-icon>
          Ver logros
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
